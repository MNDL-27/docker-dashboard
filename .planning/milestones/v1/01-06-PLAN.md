---
phase: 01-foundation
plan: 06
type: execute
wave: 3
depends_on:
  - 05
files_modified:
  - apps/api/src/routes/invites.ts
  - apps/api/src/middleware/rbac.ts
autonomous: true
requirements:
  - IDTY-05
  - IDTY-06

must_haves:
  truths:
    - User can invite other users to Organization
    - User can have RBAC roles: Owner, Admin, Operator, Viewer
  artifacts:
    - path: apps/api/src/routes/invites.ts
      provides: Organization invitation endpoints
      exports: POST /organizations/:orgId/invite, POST /invites/:token/accept
    - path: apps/api/src/middleware/rbac.ts
      provides: RBAC middleware functions
      exports: requireOrgRole, requireProjectRole
  key_links:
    - from: apps/api/src/routes/invites.ts
      to: prisma/schema.prisma
      via: OrganizationMember
      pattern: prisma\\.organizationMember\\.(create|findUnique)
    - from: apps/api/src/middleware/rbac.ts
      to: apps/api/src/routes/invites.ts
      via: middleware
      pattern: requireOrgRole
---

<objective>
Build organization invitation system and RBAC middleware for role-based access control.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/01-foundation-identity/01-RESEARCH.md (Pattern 2: Two-Level RBAC)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RBAC middleware</name>
  <files>apps/api/src/middleware/rbac.ts</files>
  <action>
Create apps/api/src/middleware/rbac.ts:

1. requireOrgRole(...roles): Check user's org membership, verify role in allowed list
2. requireProjectRole(...roles): Check user's project membership, handle inheritedFromOrg flag

Use OrgRole (OWNER, ADMIN, OPERATOR, VIEWER) and ProjectRole enums. Return 403 if not authorized.
  </action>
  <verify>
ls apps/api/src/middleware/rbac.ts
  </verify>
  <done>RBAC middleware exists with requireOrgRole and requireProjectRole</done>
</task>

<task type="auto">
  <name>Task 2: Create invitation routes</name>
  <files>apps/api/src/routes/invites.ts</files>
  <action>
Create apps/api/src/routes/invites.ts:

1. POST /organizations/:orgId/invite: Create invitation token, send email (stub for now), return token
   - Only OWNER/ADMIN can invite
   - Store: email, orgId, role, token, expiresAt, inviterUserId

2. GET /invites/:token: View invitation details (public)

3. POST /invites/:token/accept: Accept invitation, create OrganizationMember
   - Requires auth
   - If email matches invited email, create membership

4. GET /organizations/:orgId/members: List org members
  </action>
  <verify>
ls apps/api/src/routes/invites.ts
  </verify>
  <done>Invitation endpoints exist for inviting and accepting</done>
</task>

</tasks>

<verification>
Test invite flow: Create invite token, accept it as another user, verify membership created
</verification>

<success_criteria>
Users can invite others to org with roles. RBAC middleware properly restricts actions by role.
</success_criteria>

<output>
After completion, create .planning/phases/01-foundation-identity/01-06-SUMMARY.md
</output>
