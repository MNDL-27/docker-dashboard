---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on:
  - 01
files_modified:
  - apps/api/src/routes/auth.ts
  - apps/api/src/middleware/auth.ts
  - apps/api/src/config/session.ts
autonomous: true
requirements:
  - IDTY-01
  - IDTY-02

must_haves:
  truths:
    - User can sign up with email and password
    - User can log in and stay logged in via session cookies
  artifacts:
    - path: apps/api/src/routes/auth.ts
      provides: Auth endpoints (register, login, logout)
      exports: POST /register, POST /login, POST /logout
    - path: apps/api/src/middleware/auth.ts
      provides: Auth middleware to protect routes
      exports: requireAuth function
    - path: apps/api/src/config/session.ts
      provides: Express session middleware with PostgreSQL store
      exports: sessionMiddleware
  key_links:
    - from: apps/api/src/routes/auth.ts
      to: apps/api/src/config/session.ts
      via: middleware
      pattern: sessionMiddleware
    - from: apps/api/src/middleware/auth.ts
      to: prisma/schema.prisma
      via: Prisma client
      pattern: prisma\\.user\\.findUnique
---

<objective>
Build authentication API with register, login, logout using express-session and HTTP-only cookies.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/01-foundation-identity/01-RESEARCH.md (Pattern 1: Session-Based Authentication)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create session middleware config</name>
  <files>apps/api/src/config/session.ts</files>
  <action>
Create apps/api/src/config/session.ts using express-session with connect-pg-simple:

- Store: PostgreSQL session table using connect-pg-simple
- Secret: from SESSION_SECRET env var
- Cookie: httpOnly: true, secure: production, sameSite: 'lax', maxAge: 7 days
- Resave: false, saveUninitialized: false
- Create table if missing

Use research Pattern 1 as reference.
  </action>
  <verify>
ls apps/api/src/config/session.ts
  </verify>
  <done>Session middleware configured with PostgreSQL store</done>
</task>

<task type="auto">
  <name>Task 2: Create auth routes</name>
  <files>apps/api/src/routes/auth.ts</files>
  <action>
Create apps/api/src/routes/auth.ts with:

1. POST /register: Accept {email, password, name}, hash password with bcrypt (10 rounds), create user, set session.userId, return user object
2. POST /login: Accept {email, password}, find user, bcrypt.compare, set session.userId, return user object
3. POST /logout: Destroy session, clear cookie

Use 401 for invalid credentials, 400 for bad input. Return user without passwordHash.
  </action>
  <verify>
ls apps/api/src/routes/auth.ts
  </verify>
  <done>Auth routes exist with register, login, logout endpoints</done>
</task>

<task type="auto">
  <name>Task 3: Create auth middleware</name>
  <files>apps/api/src/middleware/auth.ts</files>
  <action>
Create apps/api/src/middleware/auth.ts:

- requireAuth: Returns 401 if session.userId not set, otherwise attaches user to req
- Optional: requireOrgRole, requireProjectRole for RBAC

Export middleware functions.
  </action>
  <verify>
ls apps/api/src/middleware/auth.ts
  </verify>
  <done>Auth middleware exists with requireAuth function</done>
</task>

</tasks>

<verification>
Start API server and test: curl -X POST http://localhost:3001/auth/register -H "Content-Type: application/json" -d '{"email":"test@test.com","password":"test123","name":"Test"}'
</verification>

<success_criteria>
User can register, login, logout. Session persists across requests via HTTP-only cookie.
</success_criteria>

<output>
After completion, create .planning/phases/01-foundation-identity/01-04-SUMMARY.md
</output>
