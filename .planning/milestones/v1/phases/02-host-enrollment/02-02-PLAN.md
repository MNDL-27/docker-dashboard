---
phase: 02-host-enrollment
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/api/src/routes/hosts.ts
  - apps/api/src/index.ts
autonomous: true
requirements:
  - HOST-01
  - HOST-02

must_haves:
  truths:
    - UI users can generate a one-time enrollment token for a new host
    - UI users can list hosts for their organization
  artifacts:
    - path: apps/api/src/routes/hosts.ts
      provides: Express router for host management
      contains: POST /tokens, GET /
---

<objective>
Implement Cloud API endpoints for administrators to generate host enrollment tokens and read the fleet inventory.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Host Token Endpoint</name>
  <files>apps/api/src/routes/hosts.ts, apps/api/src/index.ts</files>
  <action>
1. Create apps/api/src/routes/hosts.ts router
2. Implement POST /api/hosts/tokens:
   - Must be authenticated user with Admin/Owner role via requireOrganizationRole middleware
   - Generate a secure random token string or use UUID
   - Store inside HostToken table with 24h expiration
   - Return token and generated curl/docker command for agent installation
3. Register router in apps/api/src/index.ts under /api/hosts
  </action>
  <verify>curl test to POST /api/hosts/tokens fails without auth, creates db record with auth</verify>
  <done>API successfully issues 24hr one-time tokens</done>
</task>

<task type="auto">
  <name>Task 2: List Hosts Endpoint</name>
  <files>apps/api/src/routes/hosts.ts</files>
  <action>
Implement GET /api/hosts:
- Require Viewer or higher role
- Return all Host records for the user's current Organization
- Include the current computed status (ONLINE if lastSeen < 1 min, else OFFLINE)
- Include relation count of Containers
  </action>
  <verify>curl test to GET /api/hosts returns JSON array of hosts</verify>
  <done>Endpoint returns properly formatted host list with computed statuses</done>
</task>

</tasks>

<verification>
Ensure tests or manual verification via seeded database can hit both endpoints successfully.
</verification>

<success_criteria>
- Authenticated user can generate an enrollment token
- Authenticated user can view host list
</success_criteria>

<output>
After completion, create .planning/phases/02-host-enrollment/02-02-SUMMARY.md
</output>
