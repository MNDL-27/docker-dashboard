---
phase: 02-host-enrollment
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/api/src/routes/agent.ts
  - apps/api/src/index.ts
autonomous: true
requirements:
  - HOST-05
  - HOST-06

must_haves:
  truths:
    - Agent can exchange token for persistent credentials
    - Agent can heartbeat to keep status Online
  artifacts:
    - path: apps/api/src/routes/agent.ts
      provides: Publicly accessible router for agent ingress
      contains: POST /enroll, POST /heartbeat
---

<objective>
Implement Cloud API endpoints dedicated to agent communication (Enrollment & Heartbeats).
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent Enrollment Endpoint</name>
  <files>apps/api/src/routes/agent.ts, apps/api/src/index.ts</files>
  <action>
1. Create apps/api/src/routes/agent.ts (Note: This is separate from user API, needs different or no initial auth)
2. Implement POST /api/agent/enroll:
   - Accept JSON: { "token": "...", "name": "...", "hostname": "...", "os": "...", "architecture": "...", "dockerVersion": "..." }
   - Validate token against HostToken table (checking expiration and usedAt == null)
   - Mark token used, create Host record tied to the token's organizationId
   - Generate a strong agent identity token (e.g. JWT signed by API) to return to agent for future auth
3. Mount the router in apps/api/src/index.ts
  </action>
  <verify>curl -X POST /api/agent/enroll with valid token provisions a Host and returns credentials</verify>
  <done>Token exchanged for valid Host identity</done>
</task>

<task type="auto">
  <name>Task 2: Agent Heartbeat Endpoint</name>
  <files>apps/api/src/routes/agent.ts</files>
  <action>
Implement POST /api/agent/heartbeat:
- Create middleware `requireAgentAuth` that validates the agent's identity token
- Endpoint updates the corresponding Host's `lastSeen` timestamp to `now()`
- Return 200 OK
  </action>
  <verify>curl -X POST /api/agent/heartbeat with agent credentials updates lastSeen</verify>
  <done>Host lastSeen timestamp advances upon heartbeat</done>
</task>

</tasks>

<verification>
Verify complete flow: Create token via /api/hosts/tokens -> Enroll via /api/agent/enroll -> Heartbeat via /api/agent/heartbeat.
</verification>

<success_criteria>
- Tokens are successfully consumed and cannot be reused
- Heartbeats correctly identify the host and update lastSeen
</success_criteria>

<output>
After completion, create .planning/phases/02-host-enrollment/02-03-SUMMARY.md
</output>
