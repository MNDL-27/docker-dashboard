---
phase: 03-observability-actions
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - packages/agent/main.go
  - packages/agent/docker/client.go
  - packages/agent/client/api.go
autonomous: true
requirements:
  - METR-01
  - METR-02
  - LOGS-01
  - LOGS-02

must_haves:
  truths:
    - Agent collects memory, cpu, and network stats from Docker API
    - Agent collects real-time logs from Docker API
    - Agent connects to Cloud API via WebSocket and streams telemetry
  artifacts:
    - path: packages/agent/main.go
      provides: WebSocket connection logic and collection loops
    - path: packages/agent/docker/client.go
      provides: Method to fetch container stats and log streams
---

<objective>
Enhance the Go Agent to continuously collect metrics and stream logs from the local Docker daemon, and push them to the Cloud API over a persistent WebSocket connection.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/03-observability-actions/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add WebSocket Client to Agent</name>
  <files>packages/agent/client/api.go, packages/agent/go.mod</files>
  <action>
Add WebSocket support to the agent API client:
- Ensure the agent URL connects to `ws://` or `wss://` based on `AGENT_API_URL`.
- Add a new method `ConnectWebSocket(token string)` that opens a connection to `/ws/agent/:hostId` (host ID derived from initial enrollment payload, or just authenticate via token and the server infers hostId). Note: Go's `gorilla/websocket` or `nhooyr.io/websocket` is common; add the necessary package to `go.mod`.
- Provide a `SendMetrics(metrics []Metric)` and `SendLogs(logs []Log)` channel or method wrapper around the WebSocket connection.
  </action>
  <verify>go mod tidy && go build ./...</verify>
  <done>Agent can successfully establish a websocket connection</done>
</task>

<task type="auto">
  <name>Task 2: Implement Docker Stats & Logs Readers</name>
  <files>packages/agent/docker/client.go</files>
  <action>
Extend the Docker client to read stats and logs:
- Add `GetContainerStats(containerID string) (Stats, error)` that queries `/containers/{id}/stats?stream=false` and parses the CPU/Memory/Net metrics.
- Add `StreamContainerLogs(containerID string, logChan chan<- Log)` that connects to `/containers/{id}/logs?follow=true&stdout=true&stderr=true&tail=200` and continuously parses the multiplexed Docker log stream into a Go channel.
  </action>
  <verify>go build ./docker</verify>
  <done>Agent can read stats and tail multiplexed logs from Docker</done>
</task>

<task type="auto">
  <name>Task 3: Implement Collection Loops</name>
  <files>packages/agent/main.go</files>
  <action>
Modify the main agent loop:
- After enrollment, establish the WebSocket connection.
- Start a goroutine that ticks every 5 seconds. On every tick, range over active containers, call `GetContainerStats`, batch them, and send via WebSocket.
- Start a goroutine for every active container that calls `StreamContainerLogs` and pipes the output to the WebSocket.
- Handle Docker events (container start/stop) to dynamically add/remove log tailing goroutines.
  </action>
  <verify>go build ./...</verify>
  <done>Agent orchestrates the continuous collection and streaming to the cloud</done>
</task>

</tasks>

<verification>
Ensure the Agent compiles correctly (`go build ./...`).
</verification>

<success_criteria>
- Agent connects to WebSocket API securely.
- Agent fetches stats from Docker API.
- Agent streams logs from Docker API without blocking.
</success_criteria>

<output>
After completion, create .planning/phases/03-observability-actions/03-03-SUMMARY.md
</output>
