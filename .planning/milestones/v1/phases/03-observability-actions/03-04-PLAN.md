---
phase: 03-observability-actions
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - apps/api/src/websocket/server.ts
  - apps/api/src/services/metrics.ts
  - apps/api/src/services/logs.ts
autonomous: true
requirements:
  - METR-03
  - LOGS-03

must_haves:
  truths:
    - Cloud API receives WebSocket payloads from agents
    - Cloud API parses metrics and stores them in the database
    - Cloud API parses logs and stores them in the database
  artifacts:
    - path: apps/api/src/websocket/server.ts
      provides: Inbound message handlers for agents
    - path: apps/api/src/services/metrics.ts
      provides: Database insertion for metrics
    - path: apps/api/src/services/logs.ts
      provides: Database insertion for logs
---

<objective>
Implement the server-side WebSocket handlers in the Cloud API to ingest the metrics and log payloads arriving from the agents, and persist them to the database.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/03-observability-actions/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ingestion Services</name>
  <files>apps/api/src/services/metrics.ts, apps/api/src/services/logs.ts</files>
  <action>
Create services for handling the incoming telemetry:
- `apps/api/src/services/metrics.ts`: Export `saveMetricsBatch(hostId, metricsArray)` that uses Prisma to `createMany` records in the `ContainerMetric` table. Ensure `containerId` is resolved or passed correctly.
- `apps/api/src/services/logs.ts`: Export `saveLogsBatch(hostId, logsArray)` that uses Prisma to `createMany` records in the `ContainerLog` table.
- Implement a basic cleanup function that deletes records older than 24 hours (can be triggered randomly or via a simple cron/setInterval).
  </action>
  <verify>tsc --noEmit</verify>
  <done>Services can persist arrays of metrics and logs to Prisma</done>
</task>

<task type="auto">
  <name>Task 2: Handle Agent WS Messages</name>
  <files>apps/api/src/websocket/server.ts</files>
  <action>
Modify the WebSocket server logic:
- When an agent connects, attach a `message` event listener.
- Parse incoming JSON payloads. Determine if the payload is `type: "metrics"` or `type: "logs"`.
- Route the payload to `saveMetricsBatch` or `saveLogsBatch`.
- *Optimization Option:* Buffer incoming logs/metrics in memory for 1 second, then flush batch to database to avoid overwhelming Postgres with thousands of tiny single-insert transactions.
  </action>
  <verify>tsc --noEmit</verify>
  <done>Agent WebSocket messages are correctly parsed and passed to ingestion services</done>
</task>

</tasks>

<verification>
Ensure `npm run build` in `apps/api` compiles successfully. Verify `tsc` throws no errors regarding the Prisma schema types and ingestion services.
</verification>

<success_criteria>
- Metrics payloads from agents are bulk-inserted into the DB.
- Logs payloads from agents are bulk-inserted into the DB.
- Memory buffering or strict batching is enforced to prevent rapid connection blocking.
</success_criteria>

<output>
After completion, create .planning/phases/03-observability-actions/03-04-SUMMARY.md
</output>
