---
phase: 03-observability-actions
plan: 05
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - apps/web/src/app/(dashboard)/fleet/[hostId]/[containerId]/page.tsx
  - apps/web/src/components/observability/MetricsChart.tsx
  - apps/web/src/components/observability/LogStream.tsx
autonomous: true
requirements:
  - METR-04
  - METR-05
  - LOGS-04
  - LOGS-05
  - LOGS-06

must_haves:
  truths:
    - Web UI has a detailed container view page
    - Web UI can establish a WebSocket connection to the Cloud API
    - Real-time metrics are rendered on a line chart
    - Real-time logs are rendered in a tailing terminal view
  artifacts:
    - path: apps/web/src/app/(dashboard)/fleet/[hostId]/[containerId]/page.tsx
      provides: Container detail layout
    - path: apps/web/src/components/observability/MetricsChart.tsx
      provides: Realtime charting component (recharts/chart.js)
    - path: apps/web/src/components/observability/LogStream.tsx
      provides: Interactive log terminal
---

<objective>
Build the Web UI Observability Dashboard. This provides the user with live line charts for CPU/Memory/Network and a streaming terminal view for container logs over WebSockets.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/03-observability-actions/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Charting Library</name>
  <files>apps/web/package.json</files>
  <action>
Install a React charting library:
- Run `npm install recharts` inside `apps/web`.
  </action>
  <verify>cat package.json | grep recharts</verify>
  <done>recharts is listed in dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Build Real-time Components</name>
  <files>apps/web/src/components/observability/MetricsChart.tsx, apps/web/src/components/observability/LogStream.tsx</files>
  <action>
Create the real-time React components:
- `MetricsChart.tsx`: Accepts a generic data array and renders a beautiful Recharts `LineChart`. Add animations for a premium feel. Include X-axis (time) and Y-axis (value). 
- `LogStream.tsx`: Renders a dark, code-like box. Maintains an array of log lines. Exposes a "Pause/Resume" button (LOGS-05) and an auto-scroll to bottom behavior. Expose a "Download Logs" button (LOGS-06) that triggers a blob download of the raw text.
  </action>
  <verify>npm run build</verify>
  <done>Reusable React components for metrics and logs exist</done>
</task>

<task type="auto">
  <name>Task 3: Container Detail Page & WebSocket Wiring</name>
  <files>apps/web/src/app/(dashboard)/fleet/[hostId]/[containerId]/page.tsx</files>
  <action>
Create the Container Detail page layout:
- Fetch initial container details (name, image, status) via a standard REST API call (you may need to add a quick `GET /containers/:id` endpoint or derive from host).
- Establish a `WebSocket` connection using a React `useEffect` hook. Connect to `wss://{PUBLIC_API_URL}/ws/client?containerId={id}&ticket={token}`.
- Listen for `message` events. When `type: metrics` arrives, append to the `MetricsChart` state array (keeping the last N data points for the live 1-5s view). When `type: logs` arrives, append to the `LogStream` state array.
- To satisfy METR-05, add a toggle for historical ranges (15m/1h/6h/24h) that fallback to fetching data via REST instead of strictly live WS updates.
  </action>
  <verify>npm run build</verify>
  <done>Page renders the chart and log stream and opens a WebSocket successfully</done>
</task>

</tasks>

<verification>
Ensure `npm run build` config compiles successfully in `apps/web`. The Next.js router should cleanly build the dynamic route for container details.
</verification>

<success_criteria>
- Recharts is used for beautiful metric visualizations.
- WebSocket is managed cleanly within a React component's lifecycle (connecting on mount, cleaning up on unmount).
- Logs can be paused, resumed, and downloaded.
</success_criteria>

<output>
After completion, create .planning/phases/03-observability-actions/03-05-SUMMARY.md
</output>
