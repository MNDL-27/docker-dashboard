---
phase: 4
plan: 01
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
autonomous: true
user_setup: []

must_haves:
  truths:
    - "System can store Alert Rules (CPU, Memory, Container Down, Restart Loop)"
    - "System can track active Alerts and their lifecycle states (Firing, Resolved)"
    - "System can store Webhook configurations for rule notifications"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "AlertRule, Alert, and Webhook models"
    - path: "apps/api/prisma/schema.prisma"
      provides: "Latest compiled schema"
---

# Plan 04-01: Alerting Database Schema

<objective>
Design and implement the Prisma data models required for Phase 4 Alerting.
This encompasses Alert Rules (conditions to check), active/historical Alerts (the occurrences), and Webhooks (notification endpoints).
</objective>

<context>
Load for context:
- .planning/ROADMAP.md
- prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Alerting Models to Prisma Schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following models to `prisma/schema.prisma`:

1. `AlertRule`
   - `id` (cuid)
   - `organizationId` (String) -> Relation to Organization
   - `name` (String)
   - `condition` (String) -> Enum/String: "CONTAINER_DOWN", "RESTART_LOOP", "CPU_USAGE", "MEMORY_USAGE"
   - `threshold` (Float?) -> Value to exceed (e.g. 80 for CPU%)
   - `duration` (Int) -> How many minutes the condition must persist
   - `createdAt` / `updatedAt`

2. `Alert`
   - `id` (cuid)
   - `ruleId` (String) -> Relation to AlertRule
   - `containerId` (String) -> Relation to Container 
   - `status` (String) -> "FIRING" or "RESOLVED"
   - `startedAt` (DateTime)
   - `resolvedAt` (DateTime?)
   - `createdAt`

3. `Webhook`
   - `id` (cuid)
   - `organizationId` (String) -> Relation to Organization
   - `url` (String)
   - `secret` (String?) -> Optional HMAC secret for payload signatures
   - `isActive` (Boolean)
   - `createdAt` / `updatedAt`

Add the reverse relations to `Organization` and `Container` models where appropriate.
  </action>
  <verify>npx prisma validate --schema=./prisma/schema.prisma</verify>
  <done>Prisma schema is valid and contains AlertRule, Alert, and Webhook models</done>
</task>

<task type="auto">
  <name>Task 2: Generate Prisma Client</name>
  <files>None</files>
  <action>
Run `npx prisma generate` in `./apps/api` to ensure the API's TypeScript client has access to the new Alerting models.
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Prisma client generates without errors and API compiles.</done>
</task>

</tasks>

<verification>
After all tasks, verify:
- [ ] Schema contains `AlertRule`, `Alert`, and `Webhook`
- [ ] `npx prisma validate` passes
- [ ] Next wave (Rule Evaluation) has firm database layer.
</verification>

<success_criteria>
- [ ] All tasks verified
- [ ] Must-haves confirmed
</success_criteria>
