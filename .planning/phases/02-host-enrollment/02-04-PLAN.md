---
phase: 02-host-enrollment
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-03"]
files_modified:
  - apps/api/src/routes/agent.ts
  - apps/api/src/services/container.ts
autonomous: true
requirements:
  - CONT-02

must_haves:
  truths:
    - Cloud API can receive and store a list of containers from an agent
  artifacts:
    - path: apps/api/src/routes/agent.ts
      provides: Agent ingress for container snapshots
      contains: POST /containers
---

<objective>
Implement the Cloud API endpoint to receive and persist container snapshots from the Agent.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Container Ingestion Logic</name>
  <files>apps/api/src/services/container.ts</files>
  <action>
Create a service to handle container sync:
- Accept a list of container objects: { dockerId, name, image, imageId, command, state, status, ports, labels, startedAt }
- For a given Host, iterate through the list.
- Upsert (update or insert) containers matching the dockerId and hostId.
- Delete or mark as 'exited' any containers for the given host that were not present in the payload (optional for this specific task, but good for exact sync).
- Ensure highly efficient upsert logic to prevent db locking (e.g. Prisma `$transaction`).
  </action>
  <verify>Service compiles and can be imported</verify>
  <done>Service method `syncContainers(hostId, containers)` is ready</done>
</task>

<task type="auto">
  <name>Task 2: Agent Containers Endpoint</name>
  <files>apps/api/src/routes/agent.ts</files>
  <action>
Implement POST /api/agent/containers:
- Use `requireAgentAuth` middleware.
- Accept JSON array of containers in body.
- Call the `syncContainers` service.
- Return 200 OK with sync summary.
  </action>
  <verify>curl -X POST /api/agent/containers with agent token and payload returns 200</verify>
  <done>Endpoint successfully processes and stores the container snapshot</done>
</task>

</tasks>

<verification>
Test the endpoint via unit tests or simulated agent payload against a running dev server.
</verification>

<success_criteria>
- Container snapshots are accurately stored and updated in the database
</success_criteria>

<output>
After completion, create .planning/phases/02-host-enrollment/02-04-SUMMARY.md
</output>
