---
phase: 02-host-enrollment
plan: 05
type: execute
wave: 4
depends_on: ["02-03", "02-04"]
files_modified:
  - packages/agent/main.go
  - packages/agent/client/api.go
  - packages/agent/docker/client.go
autonomous: true
requirements:
  - HOST-04
  - HOST-06
  - CONT-01

must_haves:
  truths:
    - Agent can authenticate using enrollment token
    - Agent maintains an ongoing heartbeat loop
    - Agent can query local Docker and send container list to Cloud
  artifacts:
    - path: packages/agent/main.go
      provides: Agent entry point and main loop
    - path: packages/agent/client/api.go
      provides: HTTP client wrapper for Cloud API
    - path: packages/agent/docker/client.go
      provides: Docker engine interaction
---

<objective>
Implement the primary Agent Go logic to enroll, heartbeat, and synchronize container state with the Cloud API.
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent API Client and Enrollment</name>
  <files>packages/agent/client/api.go, packages/agent/main.go</files>
  <action>
Implement Cloud API wrapper in Go:
- `Enroll(token string)` -> calls POST /api/agent/enroll and saves returned credentials to disk or memory.
- Modify `main.go` to require an `--enroll` flag or read token from env. If token is provided, run `Enroll` and exit or start loop.
- Support reading existing credentials from a local file (`/etc/docker-dashboard/agent.json` or similar).
  </action>
  <verify>go test ./client</verify>
  <done>Client successfully executes enrollment and gets credentials</done>
</task>

<task type="auto">
  <name>Task 2: Agent Docker Client</name>
  <files>packages/agent/docker/client.go</files>
  <action>
Implement Docker inspection logic using `github.com/docker/docker/client`:
- Connect to local Docker socket (`/var/run/docker.sock`).
- Method `ListContainers()` returns a normalized struct array matching the Cloud API schema (dockerId, name, image, state, etc).
  </action>
  <verify>go build ./... && go test ./docker</verify>
  <done>Docker client extracts and normalizes the local container list</done>
</task>

<task type="auto">
  <name>Task 3: Main Agent Loop</name>
  <files>packages/agent/main.go</files>
  <action>
Implement the primary loop in main.go:
- Start tickers for Heartbeat (e.g. 30s) and Container Sync (e.g. 10s or 30s).
- On heartbeat tick: Call `POST /api/agent/heartbeat`.
- On sync tick: Call `docker.ListContainers()` and `POST /api/agent/containers`.
- Respect graceful shutdown via os signals.
  </action>
  <verify>go build -o agent main.go</verify>
  <done>Agent compiles and loop starts correctly</done>
</task>

</tasks>

<verification>
Run the agent binary with a generated token against the local dev Cloud API, verify in DB that the host comes online and containers appear.
</verification>

<success_criteria>
- Agent enrolls successfully and stores identity
- Agent sends regular heartbeats and containers
</success_criteria>

<output>
After completion, create .planning/phases/02-host-enrollment/02-05-SUMMARY.md
</output>
