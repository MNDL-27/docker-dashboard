---
phase: 03-observability-actions
plan: 01
type: execute
wave: 1
depends_on: ["02-05"]
files_modified:
  - prisma/schema.prisma
autonomous: true
requirements:
  - METR-03
  - LOGS-03
  - AUDT-01
  - AUDT-02
  - AUDT-03

must_haves:
  truths:
    - Database can store time-series metrics linked to containers
    - Database can store bounded text logs linked to containers
    - Database can store audit logs for container actions
  artifacts:
    - path: prisma/schema.prisma
      provides: ContainerMetric, ContainerLog, and AuditLog models
---

<objective>
Define the database schema required for Phase 3: Observability & Actions. This sets up the foundation for storing high-volume data (metrics/logs) and tracking user actions (audit log).
</objective>

<execution_context>
@C:/Users/proti/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/03-observability-actions/RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Metrics & Logs Models</name>
  <files>prisma/schema.prisma</files>
  <action>
Modify `prisma/schema.prisma` to include models for storing time-series data:
- Add `ContainerMetric` model: id (cuid), containerId (relation), timestamp (DateTime), cpuUsagePercent (Float), memoryUsageBytes (BigInt), networkRxBytes (BigInt), networkTxBytes (BigInt).
- Add `ContainerLog` model: id (cuid), containerId (relation), timestamp (DateTime), stream (String: stdout/stderr), message (String).
- Add indexes on `(containerId, timestamp DESC)` for fast retrieval.
- Ensure relations to the existing `Container` model are defined.
  </action>
  <verify>npx prisma validate</verify>
  <done>Schema validates correctly with new high-volume data models</done>
</task>

<task type="auto">
  <name>Task 2: Add Audit Log Model</name>
  <files>prisma/schema.prisma</files>
  <action>
Modify `prisma/schema.prisma` to include the audit trail for actions:
- Add `AuditLog` model: id (cuid), organizationId (relation), userId (relation, optional if initiated by system), targetType (String, e.g., 'CONTAINER'), targetId (String), action (String, e.g., 'START', 'STOP', 'RESTART'), status (String: 'SUCCESS', 'FAILURE'), reason (String, optional), errorDetails (String, optional), createdAt (DateTime).
- Ensure relations to `Organization` and `User` are defined based on the existing schema.
  </action>
  <verify>npx prisma format && npx prisma validate</verify>
  <done>Audit log model supports all required tracking fields</done>
</task>

<task type="auto">
  <name>Task 3: Apply Database Migration</name>
  <files>prisma/schema.prisma</files>
  <action>
Apply the schema changes to the local development database:
- Run `npx prisma db push` inside the `apps/api` or root directory (where valid).
- Run `npx prisma generate` to update the TypeScript client.
  </action>
  <verify>npx prisma db push --preview-feature</verify>
  <done>Database is successfully updated and Prisma client reflects new types</done>
</task>

</tasks>

<verification>
Ensure the Prisma client compiles successfully and the new models are accessible in `apps/api/src/lib/prisma.ts`.
</verification>

<success_criteria>
- Metrics table exists with appropriate compound indexes
- Logs table exists with appropriate compound indexes
- AuditLog table exists linked to users and organizations
- Prisma client generates without errors
</success_criteria>

<output>
After completion, create .planning/phases/03-observability-actions/03-01-SUMMARY.md
</output>
